[build]
  command  = "npm run build"
  publish  = "dist"
  functions = "netlify/functions"   # function directory lives here

[dev]
  command     = "npm run dev"
  targetPort  = 5173
  port        = 8888
  framework   = "#custom"
  autoLaunch  = true

# -------- Default headers (used by `netlify dev`) --------
# Relaxed so Vite React Fast Refresh & source maps work locally.
[[headers]]
  for = "/*"
  [headers.values]
  # Dev: force fresh loads
  Cache-Control = "no-store"
  Content-Security-Policy = """
    default-src 'self';
    script-src 'self' 'unsafe-inline' 'unsafe-eval' 'wasm-unsafe-eval';
    connect-src 'self' http://localhost:* ws://localhost:* https://vmtcofezozrblfxudauk.supabase.co https://vmtcofezozrblfxudauk.functions.supabase.co;
    img-src 'self' data: blob: https:;
    style-src 'self' 'unsafe-inline';
    font-src 'self' data:;
    worker-src 'self' blob:;
    frame-src https://vmtcofezozrblfxudauk.supabase.co;
  """

# -------- Production overrides (strict) --------
[context.production]

  # HTML must never be cached
  [[headers]]
    for = "/"
    [headers.values]
    Cache-Control = "no-cache, no-store, must-revalidate"

  [[headers]]
    for = "/*.html"
    [headers.values]
    Cache-Control = "no-cache, no-store, must-revalidate"

  [[headers]]
    for = "/index.html"
    [headers.values]
    Cache-Control = "no-cache, no-store, must-revalidate"

  # Long-cache immutable assets (Vite outputs /assets/ with content hashes)
  [[headers]]
    for = "/assets/*"
    [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

  # Optional: root-level hashed bundles, if any
  [[headers]]
    for = "/*.js"
    [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

  [[headers]]
    for = "/*.css"
    [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

  # Your stricter production CSP
  [[headers]]
    for = "/*"
    [headers.values]
    Content-Security-Policy = "default-src 'self'; script-src 'self'; connect-src 'self' https://vmtcofezozrblfxudauk.supabase.co https://vmtcofezozrblfxudauk.functions.supabase.co; img-src 'self' data: blob: https:; style-src 'self' 'unsafe-inline'; font-src 'self' data:; worker-src 'self' blob:; frame-src https://vmtcofezozrblfxudauk.supabase.co;"

# SPA fallback so /book and other client routes work
[[redirects]]
  from = "/*"
  to   = "/index.html"
  status = 200

[functions]
  node_bundler = "esbuild"
  # Externalize Twilio so esbuild doesn't try to inline it
  external_node_modules = ["twilio"]
  # (directory is already set in [build].functions)
