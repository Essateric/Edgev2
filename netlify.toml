[build]
  command  = "npm run build"
  publish  = "dist"
  functions = "netlify/functions"   # function directory lives here

[dev]
  command     = "npm run dev"
  targetPort  = 5173
  port        = 8888
  framework   = "#custom"
  autoLaunch  = true

# -------- Default headers (used by `netlify dev`) --------
# Relaxed so Vite React Fast Refresh & source maps work locally.
[[headers]]
  for = "/*"
  [headers.values]
  # Dev: force fresh loads
  Cache-Control = "no-store"


# -------- Production overrides (slightly relaxed to avoid CSP/preamble issues) --------
[context.production]

  # HTML must never be cached
  [[headers]]
    for = "/"
    [headers.values]
    Cache-Control = "no-cache, no-store, must-revalidate"

  [[headers]]
    for = "/*.html"
    [headers.values]
    Cache-Control = "no-cache, no-store, must-revalidate"

  [[headers]]
    for = "/index.html"
    [headers.values]
    Cache-Control = "no-cache, no-store, must-revalidate"

  # Long-cache immutable assets (Vite outputs /assets/ with content hashes)
  [[headers]]
    for = "/assets/*"
    [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

  # Optional: root-level hashed bundles, if any
  [[headers]]
    for = "/*.js"
    [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

  [[headers]]
    for = "/*.css"
    [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

  # Relaxed production CSP so any inline bootstrap/preamble code can run
  [[headers]]
    for = "/*"


# SPA fallback so /book and other client routes work
[[redirects]]
  from = "/*"
  to   = "/index.html"
  status = 200

[functions]
  node_bundler = "esbuild"
  # Externalize Twilio so esbuild doesn't try to inline it
  external_node_modules = ["twilio"]
  # (directory is already set in [build].functions)
